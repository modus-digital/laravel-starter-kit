name: Deploy to Development

on:
  push:
    branches:
      - dev
      - develop
      - development

jobs:
  build:
    runs-on: self-hosted
    container:
      image: serversideup/php:8.4-cli
      options: --user root

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Node.js and pnpm
        run: |
          curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
          apt-get install -y nodejs
          npm install -g pnpm@10

      - name: Install PHP Dependencies
        run: composer install --prefer-dist --no-progress --no-interaction

      - name: Install Node Dependencies
        run: pnpm install

      - name: Build Assets
        run: pnpm run build

      - name: Create Deployment Artifacts
        run: |
          tar --create --gzip \
              --exclude="bootstrap/cache/*" \
              --exclude="node_modules" \
              --exclude="public/storage" \
              --exclude="storage" \
              --exclude="tests" \
              --file artifacts.tar.gz * .deployment

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: deployment-artifacts
          path: artifacts.tar.gz
          retention-days: 1

  deploy:
    runs-on: self-hosted
    needs: build

    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: deployment-artifacts

      - name: Extract Deployment Scripts
        run: |
          tar -xf artifacts.tar.gz .deployment/prepare.sh

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H "${{ secrets.DEPLOY_SSH_HOST }}" >> ~/.ssh/known_hosts

      - name: Deploy to Development
        env:
          base_directory: ${{ secrets.DEV_BASE_DIRECTORY }}
          ssh_user: ${{ secrets.DEPLOY_SSH_USER }}
          ssh_host: ${{ secrets.DEPLOY_SSH_HOST }}
          ssh_port: ${{ secrets.DEPLOY_SSH_PORT }}
          php_executable: ${{ secrets.DEPLOY_PHP_EXECUTABLE }}
        run: |
          bash .deployment/prepare.sh "$base_directory" "$ssh_user" "$ssh_host" "$ssh_port" "$php_executable"
