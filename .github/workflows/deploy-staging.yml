name: Deploy to Staging

on:
  push:
    branches:
      - staging
      - acceptance

jobs:
  quality:
    runs-on: self-hosted

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install PHP Dependencies
        run: composer install -q --no-ansi --no-interaction --no-scripts --no-progress --prefer-dist

      - name: Install Node Dependencies
        run: pnpm install

      - name: Run Pint
        run: vendor/bin/pint

      - name: Analyze Code (PHPStan)
        run: vendor/bin/phpstan analyse --memory-limit=4G --ansi

      - name: Format Frontend
        run: pnpm run format

      - name: Lint Frontend
        run: pnpm run lint

  ci:
    runs-on: self-hosted

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.4
          tools: composer:v2
          coverage: xdebug

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install PHP Dependencies
        run: composer install --no-interaction --prefer-dist --optimize-autoloader

      - name: Install Node Dependencies
        run: pnpm install

      - name: Build Assets
        run: pnpm run build

      - name: Copy Environment File
        run: cp .env.example .env

      - name: Generate Application Key
        run: php artisan key:generate

      - name: Create Database Directory
        run: mkdir -p database

      - name: Clear Config Cache
        run: php artisan config:clear --ansi

      - name: Run Tests
        run: php artisan test --compact

  # This job checks that both lint and tests passed
  build:
    runs-on: self-hosted
    needs: [quality, ci]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          tools: composer:v2

      - name: Install PHP Dependencies
        run: composer install --prefer-dist --no-progress --no-interaction --no-dev

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install Node Dependencies
        run: pnpm install

      - name: Build Assets
        run: pnpm run build

      - name: Create Deployment Artifacts
        run: |
          tar --create --gzip \
              --exclude="bootstrap/cache/*" \
              --exclude="node_modules" \
              --exclude="public/storage" \
              --exclude="storage" \
              --exclude="tests" \
              --file artifacts.tar.gz * .deployment

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: deployment-artifacts
          path: artifacts.tar.gz
          retention-days: 1

  deploy:
    runs-on: self-hosted
    needs: build

    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: deployment-artifacts

      - name: Extract Deployment Scripts
        run: |
          tar -xf artifacts.tar.gz .deployment/prepare.sh

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H "${{ secrets.DEPLOY_SSH_HOST }}" >> ~/.ssh/known_hosts

      - name: Deploy to Staging
        env:
          base_directory: ${{ secrets.STAGING_BASE_DIRECTORY }}
          ssh_user: ${{ secrets.DEPLOY_SSH_USER }}
          ssh_host: ${{ secrets.DEPLOY_SSH_HOST }}
          ssh_port: ${{ secrets.DEPLOY_SSH_PORT }}
          php_executable: ${{ secrets.DEPLOY_PHP_EXECUTABLE }}
        run: |
          bash .deployment/prepare.sh "$base_directory" "$ssh_user" "$ssh_host" "$ssh_port" "$php_executable"
