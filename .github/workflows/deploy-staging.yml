name: Deploy to Staging

on:
  workflow_run:
    workflows: ['linter', 'tests']
    types:
      - completed
    branches:
      - staging
      - acceptance

jobs:
  # This job checks that both lint and tests passed
  check-prerequisites:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    outputs:
      all-checks-passed: ${{ steps.check-status.outputs.all-passed }}

    steps:
      - name: Check all required workflows passed
        id: check-status
        uses: actions/github-script@v7
        with:
          script: |
            const { data: checkRuns } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.payload.workflow_run.head_sha,
            });

            const requiredChecks = ['quality', 'ci'];
            const checkStatuses = {};

            for (const check of checkRuns.check_runs) {
              if (requiredChecks.includes(check.name)) {
                checkStatuses[check.name] = check.conclusion;
              }
            }

            const allPassed = requiredChecks.every(name => checkStatuses[name] === 'success');

            console.log('Check statuses:', checkStatuses);
            console.log('All passed:', allPassed);

            core.setOutput('all-passed', allPassed);

            if (!allPassed) {
              core.setFailed('Not all required checks have passed yet');
            }

  build:
    runs-on: ubuntu-latest
    needs: check-prerequisites
    if: ${{ needs.check-prerequisites.outputs.all-checks-passed == 'true' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          tools: composer:v2

      - name: Install PHP Dependencies
        run: composer install --prefer-dist --no-progress --no-interaction --no-dev

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install Node Dependencies
        run: pnpm install

      - name: Build Assets
        run: pnpm run build

      - name: Create Deployment Artifacts
        run: |
          tar --create --gzip \
              --exclude="bootstrap/cache/*" \
              --exclude="node_modules" \
              --exclude="public/storage" \
              --exclude="storage" \
              --exclude="tests" \
              --file artifacts.tar.gz * .deployment

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: deployment-artifacts
          path: artifacts.tar.gz
          retention-days: 1

  deploy:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: deployment-artifacts

      - name: Extract Deployment Scripts
        run: |
          tar -xf artifacts.tar.gz .deployment/prepare.sh

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H "${{ secrets.DEPLOY_SSH_HOST }}" >> ~/.ssh/known_hosts

      - name: Deploy to Staging
        env:
          base_directory: ${{ secrets.STAGING_BASE_DIRECTORY }}
          ssh_user: ${{ secrets.DEPLOY_SSH_USER }}
          ssh_host: ${{ secrets.DEPLOY_SSH_HOST }}
          ssh_port: ${{ secrets.DEPLOY_SSH_PORT }}
          php_executable: ${{ secrets.DEPLOY_PHP_EXECUTABLE }}
        run: |
          bash .deployment/prepare.sh "$base_directory" "$ssh_user" "$ssh_host" "$ssh_port" "$php_executable"
