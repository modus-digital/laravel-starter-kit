name: Deploy to Production

on:
  push:
    branches:
      - main
      - master
      - production

jobs:
  code-quality:
    runs-on: self-hosted
    container:
      image: lorisleiva/laravel-docker:8.4

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Node.js and pnpm
        run: apk add --no-cache nodejs npm && npm install -g pnpm@10

      - name: Install PHP Dependencies
        run: composer install -q --no-ansi --no-interaction --no-scripts --no-progress --prefer-dist

      - name: Install Node Dependencies
        run: pnpm install

      - name: Run Pint
        run: vendor/bin/pint

      - name: Analyze Code (PHPStan)
        run: vendor/bin/phpstan analyse --memory-limit=4G --ansi

      - name: Format Frontend
        run: pnpm run format

      - name: Lint Frontend
        run: pnpm run lint

  tests:
    runs-on: self-hosted
    container:
      image: lorisleiva/laravel-docker:8.4

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Node.js and pnpm
        run: apk add --no-cache nodejs npm && npm install -g pnpm@10

      - name: Install PHP Dependencies
        run: composer install --no-interaction --prefer-dist --optimize-autoloader

      - name: Install Node Dependencies
        run: pnpm install

      - name: Build Assets
        run: pnpm run build

      - name: Copy Environment File
        run: cp .env.example .env

      - name: Generate Application Key
        run: php artisan key:generate

      - name: Create Database Directory
        run: mkdir -p database

      - name: Clear Config Cache
        run: php artisan config:clear --ansi

      - name: Run Tests
        run: php artisan test --compact

  # This job checks that both lint and tests passed
  compile-assets:
    runs-on: self-hosted
    container:
      image: lorisleiva/laravel-docker:8.4

    needs: [code-quality, tests]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Node.js and pnpm
        run: apk add --no-cache nodejs npm && npm install -g pnpm@10

      - name: Install PHP Dependencies
        run: composer install --prefer-dist --no-progress --no-interaction --no-dev

      - name: Install Node Dependencies
        run: pnpm install

      - name: Build Assets
        run: pnpm run build

      - name: Create Deployment Artifacts
        run: |
          tar --create --gzip \
              --exclude="bootstrap/cache/*" \
              --exclude="node_modules" \
              --exclude="public/storage" \
              --exclude="storage" \
              --exclude="tests" \
              --file artifacts.tar.gz * .deployment

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: deployment-artifacts
          path: artifacts.tar.gz
          retention-days: 1

  deploy:
    runs-on: self-hosted
    needs: compile-assets
    container:
      image: atlassian/default-image:5

    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: deployment-artifacts

      - name: Extract Deployment Scripts
        run: |
          tar --overwrite -xf artifacts.tar.gz .deployment/prepare.sh

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          key_path="$RUNNER_TEMP/deploy_id_ed25519"
          printf '%s\n' "${{ secrets.DEPLOY_PRIVATE_KEY }}" | tr -d '\r' > "$key_path"
          chmod 600 "$key_path"
          echo "DEPLOY_SSH_KEY_PATH=$key_path" >> "$GITHUB_ENV"
          ssh-keyscan -H "${{ secrets.DEPLOY_SSH_HOST }}" >> ~/.ssh/known_hosts

      - name: Deploy to Production
        env:
          base_directory: ${{ secrets.PROD_BASE_DIRECTORY }}
          ssh_user: ${{ secrets.DEPLOY_SSH_USER }}
          ssh_host: ${{ secrets.DEPLOY_SSH_HOST }}
          ssh_port: ${{ secrets.DEPLOY_SSH_PORT }}
          php_executable: ${{ secrets.DEPLOY_PHP_EXECUTABLE }}
          DEPLOY_SSH_KEY_PATH: ${{ env.DEPLOY_SSH_KEY_PATH }}
        run: |
          bash .deployment/prepare.sh "$base_directory" "$ssh_user" "$ssh_host" "$ssh_port" "$php_executable"
