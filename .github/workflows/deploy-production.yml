name: Deploy to Production

on:
  push:
    branches:
      - main
      - master
      - production

jobs:
  code-quality:
    runs-on: self-hosted
    container:
      image: serversideup/php:8.4-cli
      options: --user modus

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Node.js and pnpm
        run: |
          curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
          apt-get install -y nodejs
          npm install -g pnpm@10

      - name: Install PHP Dependencies
        run: composer install -q --no-ansi --no-interaction --no-scripts --no-progress --prefer-dist

      - name: Install Node Dependencies
        run: pnpm install

      - name: Run Pint
        run: vendor/bin/pint

      - name: Analyze Code (PHPStan)
        run: vendor/bin/phpstan analyse --memory-limit=4G --ansi

      - name: Format Frontend
        run: pnpm run format

      - name: Lint Frontend
        run: pnpm run lint

  tests:
    runs-on: self-hosted
    container:
      image: serversideup/php:8.4-cli
      options: --user modus

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install PHP Extensions
        run: install-php-extensions gd

      - name: Install Node.js and pnpm
        run: |
          curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
          apt-get install -y nodejs
          npm install -g pnpm@10

      - name: Install PHP Dependencies
        run: composer install --no-interaction --prefer-dist --optimize-autoloader

      - name: Install Node Dependencies
        run: pnpm install

      - name: Build Assets
        run: pnpm run build

      - name: Copy Environment File
        run: cp .env.example .env

      - name: Generate Application Key
        run: php artisan key:generate

      - name: Create Database Directory
        run: mkdir -p database

      - name: Clear Config Cache
        run: php artisan config:clear --ansi

      - name: Run Tests
        run: php artisan test --compact

  # This job checks that both lint and tests passed
  compile-assets:
    runs-on: self-hosted
    container:
      image: serversideup/php:8.4-cli
      options: --user modus
    needs: [code-quality, tests]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install Node.js and pnpm
        run: |
          curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
          apt-get install -y nodejs
          npm install -g pnpm@10

      - name: Install PHP Dependencies
        run: composer install --prefer-dist --no-progress --no-interaction --no-dev

      - name: Install Node Dependencies
        run: pnpm install

      - name: Build Assets
        run: pnpm run build

      - name: Create Deployment Artifacts
        run: |
          tar --create --gzip \
              --exclude="bootstrap/cache/*" \
              --exclude="node_modules" \
              --exclude="public/storage" \
              --exclude="storage" \
              --exclude="tests" \
              --file artifacts.tar.gz * .deployment

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: deployment-artifacts
          path: artifacts.tar.gz
          retention-days: 1

  deploy:
    runs-on: self-hosted
    needs: compile-assets

    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: deployment-artifacts

      - name: Extract Deployment Scripts
        run: |
          tar --overwrite -xf artifacts.tar.gz .deployment/prepare.sh

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H "${{ secrets.DEPLOY_SSH_HOST }}" >> ~/.ssh/known_hosts

      - name: Deploy to Production
        env:
          base_directory: ${{ secrets.PROD_BASE_DIRECTORY }}
          ssh_user: ${{ secrets.DEPLOY_SSH_USER }}
          ssh_host: ${{ secrets.DEPLOY_SSH_HOST }}
          ssh_port: ${{ secrets.DEPLOY_SSH_PORT }}
          php_executable: ${{ secrets.DEPLOY_PHP_EXECUTABLE }}
        run: |
          bash .deployment/prepare.sh "$base_directory" "$ssh_user" "$ssh_host" "$ssh_port" "$php_executable"
